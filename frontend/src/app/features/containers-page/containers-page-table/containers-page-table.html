<p-table
  #dt2
  [globalFilterFields]="['name', 'short_id']"
  dataKey="name"
  sortField="name"
  [scrollable]="true"
  scrollHeight="flex"
  [value]="list()"
>
  <ng-template #header>
    <tr>
      <th pFrozenColumn>
        <p-iconfield iconPosition="left">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input
            #searchInput
            id="containers-search"
            pInputText
            type="text"
            (input)="dt2.filterGlobal($event.target.value, 'contains')"
            [placeholder]="'CONTAINERS.TABLE.SEARCH_PLACEHOLDER' | translate"
          />
        </p-iconfield>
      </th>
      <th colspan="4"></th>
      <th>
        <p-split-button
          [disabled]="isLoading()"
          [label]="'GENERAL.REFRESH' | translate"
          [model]="headerButtonMenu()"
          (onClick)="updateList()"
        ></p-split-button>
      </th>
    </tr>

    @if (checkAllProgress(); as prog) {
      <tr>
        <th colspan="6">
          @if (prog.status !== ECheckStatus.DONE && prog.status !== ECheckStatus.ERROR) {
            <p-progress-bar
              [style.height.px]="6"
              [showValue]="false"
              mode="indeterminate"
            ></p-progress-bar>
          } @else {
            <section class="check-results">
              @if (prog.updated !== undefined) {
                <p-tag [severity]="prog.updated > 0 ? 'success' : 'secondary'">
                  {{ 'CONTAINERS.TABLE.HEADER_PROGRESS.UPDATED' | translate }}: {{ prog.updated }}
                </p-tag>
              }
              @if (prog.available !== undefined) {
                <p-tag [severity]="prog.available > 0 ? 'info' : 'secondary'">
                  {{ 'CONTAINERS.TABLE.HEADER_PROGRESS.AVAILABLE' | translate }}:
                  {{ prog.available }}
                </p-tag>
              }

              @if (prog.rolledback !== undefined) {
                <p-tag [severity]="prog.rolledback > 0 ? 'warn' : 'secondary'">
                  {{ 'CONTAINERS.TABLE.HEADER_PROGRESS.ROLLEDBACK' | translate }}:
                  {{ prog.rolledback }}
                </p-tag>
              }
              @if (prog.failed !== undefined) {
                <p-tag [severity]="prog.failed > 0 ? 'danger' : 'secondary'">
                  {{ 'CONTAINERS.TABLE.HEADER_PROGRESS.FAILED' | translate }}: {{ prog.failed }}
                </p-tag>
              }
            </section>
          }
        </th>
      </tr>
    }

    <tr>
      <th
        pFrozenColumn
        pSortableColumn="name"
        class="name-header"
      >
        {{ 'CONTAINERS.TABLE.NAME' | translate }}
        <p-sortIcon field="name"></p-sortIcon>
      </th>
      <th pSortableColumn="status">
        {{ 'CONTAINERS.TABLE.STATUS' | translate }}
        <p-sortIcon field="status"></p-sortIcon>
      </th>
      <th pSortableColumn="health">
        {{ 'CONTAINERS.TABLE.HEALTH' | translate }}
        <p-sortIcon field="health"></p-sortIcon>
      </th>
      <th pSortableColumn="check_enabled">
        {{ 'CONTAINERS.TABLE.CHECK_ENABLED' | translate }}
        <i
          class="pi pi-question-circle"
          style="margin: 0 0.5rem"
          [pTooltip]="'CONTAINERS.TABLE.CHECK_HINT' | translate"
          tooltipPosition="left"
        ></i>
        <p-sortIcon field="check_enabled"></p-sortIcon>
      </th>
      <th pSortableColumn="update_enabled">
        {{ 'CONTAINERS.TABLE.UPDATE_ENABLED' | translate }}
        <i
          class="pi pi-question-circle"
          style="margin: 0 0.5rem"
          [pTooltip]="'CONTAINERS.TABLE.UPDATE_HINT' | translate"
          tooltipPosition="left"
        ></i>
        <p-sortIcon field="update_enabled"></p-sortIcon>
      </th>
      <th>
        <!-- For menu -->
      </th>
    </tr>
  </ng-template>

  <ng-template
    #body
    let-container
    let-expanded="expanded"
  >
    <tr>
      <td pFrozenColumn>
        <span class="name-cell">
          <p-button
            type="button"
            pRipple
            [pRowToggler]="container"
            severity="contrast"
            [rounded]="true"
            [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
          />
          {{ container.name }}
        </span>
      </td>
      <td>
        <p-tag
          [severity]="EContainerStatusSeverity[container.status]"
          [value]="container.status"
        ></p-tag>
      </td>
      <td>
        <p-tag
          [severity]="EContainerHealthSevirity[container.health] ?? 'secondary'"
          [value]="container.health"
        ></p-tag>
      </td>
      <td>
        @if (!container.is_self) {
          <p-togglebutton
            severity="success"
            [ngModel]="container.check_enabled"
            (ngModelChange)="onCheckEnabledChange($event, container)"
            [onLabel]="'GENERAL.ENABLED' | translate"
            [offLabel]="'GENERAL.DISABLED' | translate"
            [onIcon]="'pi pi-check-circle'"
            [offIcon]="'pi pi-circle-off'"
          />
        }
      </td>
      <td>
        @if (!container.is_self) {
          <p-togglebutton
            [disabled]="!container.check_enabled"
            [ngModel]="container.update_enabled"
            (ngModelChange)="onUpdateEnabledChange($event, container)"
            [onLabel]="'GENERAL.ENABLED' | translate"
            [offLabel]="'GENERAL.DISABLED' | translate"
            [onIcon]="'pi pi-check-circle'"
            [offIcon]="'pi pi-circle-off'"
          />
        }
      </td>
      <td>
        <p-split-button
          [label]="container.splitButton.label"
          [model]="container.splitButton.items"
          [severity]="container.splitButton.severity"
          (onClick)="container.splitButton.command()"
        ></p-split-button>
      </td>
    </tr>

    @if (
      container.checkStatus &&
      container.checkStatus !== ECheckStatus.DONE &&
      container.checkStatus !== ECheckStatus.ERROR
    ) {
      <tr>
        <td colspan="6">
          <p-progress-bar
            [style.height.px]="6"
            [showValue]="false"
            mode="indeterminate"
          ></p-progress-bar>
        </td>
      </tr>
    }

    <ng-template
      #expandedrow
      let-container
    >
      <tr>
        <td colspan="6">
          <div class="extra-info">
            <p-fieldset [legend]="'CONTAINERS.TABLE.IMAGE' | translate">
              {{ container.image }}
            </p-fieldset>
            <p-fieldset [legend]="'CONTAINERS.TABLE.SHORT_ID' | translate">
              {{ container.short_id }}
            </p-fieldset>
            <p-fieldset [legend]="'CONTAINERS.TABLE.PORTS' | translate">
              <ng-container
                [ngTemplateOutlet]="portsTemplate"
                [ngTemplateOutletContext]="{ ports: container.ports }"
              ></ng-container>
            </p-fieldset>
            <p-fieldset [legend]="'CONTAINERS.TABLE.CHECKED_AT' | translate">
              {{ container.checked_at | naiveDate | date: 'medium' }}
            </p-fieldset>
            <p-fieldset [legend]="'CONTAINERS.TABLE.UPDATED_AT' | translate">
              {{ container.updated_at | naiveDate | date: 'medium' }}{{ '' }}
            </p-fieldset>
          </div>
        </td>
      </tr>
    </ng-template>
  </ng-template>
</p-table>

<ng-template
  #portsTemplate
  let-ports="ports"
>
  <section class="ports">
    @if (ports) {
      @for (item of ports | keyvalue; track item) {
        @for (hp of $any(item.value); track hp) {
          {{ hp.HostIp }}:{{ hp.HostPort }}<br />
        }
        <span>:{{ item.key }}</span>
      }
    }
  </section>
</ng-template>
